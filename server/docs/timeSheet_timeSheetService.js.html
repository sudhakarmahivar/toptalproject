<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>JSDoc: Source: timeSheet/timeSheetService.js</title>

    <script src="scripts/prettify/prettify.js"> </script>
    <script src="scripts/prettify/lang-css.js"> </script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
</head>

<body>

<div id="main">

    <h1 class="page-title">Source: timeSheet/timeSheetService.js</h1>

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>const { Between } = require("typeorm");

const { UserContext, utils, errorMessages } = require("../../framework/framework");
const { getRepository } = require("../../framework/datastore/dbConnectionManager");
const TimeSheetModel = require("./model/timeSheetModel");
const roles = require("../common/roles");
const ValidationError = require("../../framework/errors/validationError");
const AuthorizationError = require("../../framework/errors/authorizationError");
const ResourceNotFoundError = require("../../framework/errors/ResourceNotFoundError");
/**
 * Timesheet business functionality implemented here
 * Service created independant calling mechanism ( http, message triggered etc)
 * No reference of http verb should be made
 */
class TimeSheetService {
  repository = null;
  userContext = null;

  constructor(repository, userContext) {
    this.repository = repository || getRepository(TimeSheetModel);
    this.userContext = userContext || UserContext.get();
  }
  //
  // Helper Methods
  //
  validateModel(timeSheet) {
    if (!timeSheet.date || !utils.isValidPastDate(timeSheet.date)) {
      //not a valid date
      throw new ValidationError(errorMessages.validDateRequired);
    }

    if (!timeSheet.hours || timeSheet.hours > 24) {
      //not a valid date
      throw new ValidationError(errorMessages.validHoursRequired);
    }
    if (!timeSheet.activity) {
      //not a valid date
      throw new ValidationError(errorMessages.validActivityRequired);
    }
  }
  async validateDayTotal(timeSheetModel) {
    const dayTimeSheets = await this.getTimesheets({ date: timeSheetModel.date, userId: timeSheetModel.userId });
    //get total of other rows
    //In case of update, exclude current row being updated
    let total = dayTimeSheets.reduce((v, ts) => (ts.timeSheetId === timeSheetModel.timeSheetId ? v : v + ts.hours), 0);
    total += timeSheetModel.hours;

    if (total > 24) {
      throw new ValidationError(errorMessages.TotalDayHoursExceedLimit);
    }
  }
  //Get active timesheets based on time sheet attributes
  async getTimesheets(timeSheetModel) {
    //if query string passed use the same, else get alltimesheets for the user Id sent
    let timeSheets = await this.repository.find({ deleted: false, ...timeSheetModel });
    return timeSheets;
  }

  //
  // Service End Points
  //
  /**
   * Searches timesheets for specified user, fromDate and toDate
   * By default searches for logged in user
   * Specified user used only when authorization exist
   * @async
   * @param {*} timeSheetSearchModel
   */
  async search(timeSheetSearchModel) {
    //create where clause with passed search parameters
    const { fromDate, toDate, userId } = timeSheetSearchModel;
    const whereClause = {};
    if (fromDate &amp;&amp; toDate) {
      whereClause.date = Between(fromDate, toDate);
    }
    //If admin allow him/her to query other users
    if (userId &amp;&amp; this.userContext.role === roles.admin) {
      whereClause.userId = userId;
    }
    //if user not set, set it to logged in user
    if (!whereClause.userId) whereClause.userId = this.userContext.userId;
    whereClause.deleted = false;
    return await this.repository.find(whereClause);
  }

  /**
   * Creates new timesheet, post validation
   * Admins can create timesheets for other users
   * @async
   * @param {*} timeSheetModel
   */
  async create(timeSheetModel) {
    const { userId, role } = this.userContext;
    //if admin and userId sent, use the same. In all other cases overwrite with logged in user
    if (role !== roles.admin) {
      //allow only creating timesheets for self
      if (timeSheetModel.userId) {
        //model has timesheet sent. Check if its done for other users
        if (timeSheetModel.userId !== userId) throw new AuthorizationError(errorMessages.unauthorizedForTimeSheet);
      }
      timeSheetModel.userId = userId;
    }
    timeSheetModel.deleted = false;
    timeSheetModel.createdBy = userId;
    timeSheetModel.timeSheetId = null;
    this.validateModel(timeSheetModel);

    //Validate day total doesn't exceed
    await this.validateDayTotal(timeSheetModel);

    timeSheetModel = await this.repository.save(timeSheetModel);
    return timeSheetModel;
  }

  /**
   * Updates uses timesheet
   * @async
   * @param {*} timeSheetModel
   */
  async update(timeSheetModel) {
    const { role, userId } = this.userContext;
    //validate if timesheet already exists
    var dbTimeSheets = await this.getTimesheets({ timeSheetId: timeSheetModel.timeSheetId });
    if (dbTimeSheets.length === 0) {
      //no matching time sheet
      throw new ResourceNotFoundError("Timesheet not found");
    }

    const dbTimeSheet = dbTimeSheets[0];
    if (dbTimeSheet.userId !== userId &amp;&amp; role !== roles.admin) {
      throw new AuthorizationError(errorMessages.unauthorizedForTimeSheet);
    }

    timeSheetModel.userId = dbTimeSheet.userId;
    timeSheetModel.updatedBy = userId;
    this.validateModel(timeSheetModel);
    await this.validateDayTotal(timeSheetModel);
    timeSheetModel = await this.repository.save(timeSheetModel);
    return timeSheetModel;
  }
  /**
   * Delete timesheet based on timeSheetId
   * @async
   * @param {Number} timeSheetId
   */
  async delete(timeSheetId) {
    const { role, userId } = this.userContext;
    //validate if timesheet already exists
    var dbTimeSheets = await this.getTimesheets({ timeSheetId });
    if (dbTimeSheets.length === 0) {
      //no matching time sheet
      throw new ResourceNotFoundError("Timesheet not found");
    }
    let dbTimeSheet = dbTimeSheets[0];
    if (dbTimeSheet.userId !== userId &amp;&amp; role !== roles.admin) {
      throw new AuthorizationError(errorMessages.unauthorizedForTimeSheet);
    }
    dbTimeSheet.deleted = true;
    dbTimeSheet = await this.repository.save(dbTimeSheet);
    return dbTimeSheet;
  }
}
module.exports = TimeSheetService;
</code></pre>
        </article>
    </section>




</div>

<nav>
    <h2><a href="index.html">Home</a></h2><h3>Classes</h3><ul><li><a href="TimeSheetService.html">TimeSheetService</a></li><li><a href="UserService.html">UserService</a></li></ul>
</nav>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc/jsdoc">JSDoc 3.6.6</a> on Tue Feb 09 2021 14:00:38 GMT+0530 (India Standard Time)
</footer>

<script> prettyPrint(); </script>
<script src="scripts/linenumber.js"> </script>
</body>
</html>
